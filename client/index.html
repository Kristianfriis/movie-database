<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#fff" media="(prefers-color-scheme: light)" />
  <meta name="theme-color" content="#121212" media="(prefers-color-scheme: dark)" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes">
  <title>My Movie Library</title>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
  <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/palettes/dark.class.css" />
  <link href="https://cdn.jsdelivr.net/npm/@ionic/vue@8.7.5/css/core.min.css" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/favicon.ico" sizes="any">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <link rel="stylesheet" href="styles.css" />
  <style>
    #app {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #ccc;
      border-top-color: #42b983;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="spinner"></div>
  </div>
</body>
<script>
  const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)')

  var darkModeClassName = 'ion-palette-dark'

  // Initial check
  if (mediaQuery.matches) {
    document.documentElement.classList.add(darkModeClassName)
  } else {
    document.documentElement.classList.remove(darkModeClassName)
  }

  // Listen for changes
  mediaQuery.addEventListener('change', (e) => {
    if (e.matches) {
      document.documentElement.classList.add(darkModeClassName)
    } else {
      document.documentElement.classList.remove(darkModeClassName)
    }
  })

  window.appConfig = {
    apiUrl: location.hostname === 'localhost' || location.hostname === '127.0.0.1'
      ? 'https://localhost:7154'
      : 'https://movie-database-internal-dmeph2fgdmhuf0b3.westeurope-01.azurewebsites.net'
  }
</script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script type="importmap">
{
  "imports": {
    "vue": "https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.41/vue.esm-browser.prod.js",
    "vue-router": "https://cdnjs.cloudflare.com/ajax/libs/vue-router/4.1.5/vue-router.esm-browser.min.js",
    "@vue/devtools-api": "https://unpkg.com/@vue/devtools-api@6.4.5/lib/esm/index.js",
    "@ionic/ionicvue": "https://cdn.jsdelivr.net/npm/@ionic/vue@8.7.5/+esm",
    "@ionic/core" : "https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/index.esm.js"
  }
}
</script>
<script type="module">
  import { createApp } from 'vue'
  import { IonicVue } from "@ionic/ionicvue"
  import { createRouter, createWebHashHistory } from 'vue-router';
  import { menuController } from "@ionic/core"
  window.__VUE_PROD_DEVTOOLS__ = false; // ðŸ‘ˆ Add this line
  import { router } from './router.js'
  import { supabase } from './services/supabase.js'
  import { UserService } from './services/user-service.js'
  import { MovieService } from './services/movie-service.js'

  import { store } from './services/state.js'

  const App = {
    data() {
      return {
        store
      }
    },
    async created() {
      var collections = await MovieService.getAllCollections();
    },
    methods: {
      back() {
        history.back();
        this.store.showBackButton = false;
      },
      navigate(path) {
        router.push(path);
        menuController.close();
      },
      async logout() {
        // this.store.user = null;
        // this.store.isAuthenticated = false;
        await supabase.auth.signOut()
        await UserService.clearCache();
        router.push('/login');
        menuController.close();
      }
    },
    template:/*html*/`
      <ion-app>
          <!-- Side Menu -->
          <ion-menu content-id="main-content" swipeGesture="true">
            <ion-header>
              <ion-toolbar>
                <ion-title>Menu</ion-title>
              </ion-toolbar>
            </ion-header>
            <ion-content>
              <ion-list>
                <ion-item button @click="navigate('/')">Search</ion-item>
                <ion-item button @click="navigate('/add')">Add Movie</ion-item>
                <ion-item button @click="navigate('/profile')">Profile</ion-item>
                <ion-item button @click="logout">Logout</ion-item>
              </ion-list>
            </ion-content>
          </ion-menu>

          <!-- Main Content -->
          <div class="ion-page" id="main-content">
            <ion-header>
              <ion-toolbar>
                <ion-buttons slot="start">
                  <ion-menu-button></ion-menu-button>
                </ion-buttons>
                <ion-title>ðŸŽ¬ My Movie Library</ion-title>
              </ion-toolbar>
            </ion-header>

            <ion-content>
              <router-view></router-view>
            </ion-content>
   </div>
        </ion-app>
      `
  }

  createApp(App).use(IonicVue).use(router).mount('#app')
</script>

</html>